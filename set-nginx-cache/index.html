<!DOCTYPE html>
<html lang="zh-CN">
  
  <head>
  <script>
    if (!!window.ActiveXObject || "ActiveXObject" in window || navigator.userAgent.indexOf("Edge") > -1) {
      document.execCommand("stop");
      alert("页面已停止加载，请使用非IE内核浏览器访问本站点！！");
    }
  </script>
  <meta charset="UTF-8">
  <title>
    
      Nginx下关于缓存控制字段cache-control的配置 - LERNB | 网络日志
    
  </title>
  <!-- <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0"> -->
  <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />
  <meta name="description" content="LERNB - 学习、记录、分享 - LERNB" />
  <meta name="keywords" content="LERNB,技术,分享,博客,IT新闻,互联网,Internet,数码,科技,网络,科普,通信,智能手机,blog" />
  <meta name="author" content="LERNB">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="format-detection" content="telephone=no, email=no" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="x5-fullscreen" content="true">
	<meta name="full-screen" content="yes">
	<meta name="x5-page-mode" content="app">
	<meta name="browsermode" content="application">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="msapplication-TileColor" content="#5e72e4">

	<meta name="application-name" content="LERNB">
	<meta name="apple-mobile-web-app-title" content="LERNB">
  <link href="/asset/favicon.png" rel="apple-touch-icon-precomposed">
  <link href="/asset/favicon.png" rel="Shortcut Icon" type=image/x-icon>
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/lernb20201012.css?v=07182049">
  <link rel="stylesheet" href="/css/aIndex.css?v=07222049">
  <link rel="stylesheet" href="/css/prism20200918.css?v=05171938">
</head>
  
  <body class="line-numbers">
  
  <div class="pgbar">
    <div class="bar-in"></div>
  </div>
  <script src="/js/layouts@20200929.js"></script>
  <!-- <script id="header-js"></script>
  <script type="text/javascript">
    let headerJs = document.getElementById('header-js');
    if (screen.width < 768) {
      headerJs.setAttribute('src', '');
    } else {
      headerJs.setAttribute('src', '/js/layouts@20200921.js');
    }
  </script> -->
<!-- <body onload="prettyPrint();" class="line-numbers"> 旧款代码高亮 -->
  
    
  <div class="headhead">

<!-- <div class="headhead headbdf"> -->
  <div class="header-wrap" id="he" style="height: 55px;">
    <div class="blur-bg"></div>
    
    <div class="head">
    
      <button onclick="clk()">
        <!-- <i class="fa fa-bars" id="show" aria-hidden="true"></i>
        <i class="fa fa-times" id="close" aria-hidden="true"></i> -->
        <span id="show"><i></i></span>
        <span id="close"></span>
      </button>
      <h1 style="display: inline-block;">
        <a class="header-img" href="/" target="_self" title="LERNB">
          LERNB
        </a>
      </h1>
      <ul id="header-btn">
        <li>
          
          <a href="/" class="hoverLine" style="padding-left: 0;">主页</a>
          
        </li>
        <li>
          
          <a href="/articles" class="hoverLine hoverLineActive" style="padding-left: 0;">文章</a>
          
        </li>
        <li>
          
          <a href="/note/note-intro.html" class="hoverLine" style="padding-left: 0;">学习</a>
          
        </li>
        <!-- <li> -->
          
          <!-- <a href="/tags" class="tag-btn hoverLine">标签</a> -->
          
        <!-- </li> -->
        <!-- <li> -->
          
          <!-- <a href="/categories" class="cate-btn hoverLine">分类</a> -->
          
        <!-- </li> -->
      </ul>
    </div>
    <div id="hcata">
      <!-- <img src="/asset/u2.jpg" alt="头像" style="display: block; width: 100px; height: 100px; border-radius: 50%; margin: 30px auto 30px;">
      <div class="barauthor" style="text-align: center; font-family: cmFont; font-size: 1.6rem; color: #18a0db;">lernb.</div> -->

      <!-- author -->

      <div class="headerMenu">
        <a href="/">主页</a>
        <a href="/articles">文章</a>
        <a href="/tags">标签</a>
        <a href="/note/note-intro.html">学习</a>
        <!-- <a href="/categories">分类</a> -->
      </div>
      
    </div>
  </div>
</div>
    
    <div class="wrap clearfix">
      
  
  <div class="main" style="padding-top: 60px; box-shadow: initial; background-color: initial; backdrop-filter: initial;-webkit-backdrop-filter: initial;">
  
    <div class="wrap-content clearfix">
      
      <div class="bar barbar">
        <!-- <div class="barside"> -->
        <!-- S 侧栏插件 -->
        

        <!-- 最近文章 -->
        
        <div class="bar-item">
  <div class="t-h hRec" style="margin-bottom: 20px;">
    <h3 style="font-weight: bold; font-size: 18px;">最近</h3>
  </div>
  <ul>
    
      <!-- <span class="post-date">2021-04-27</span> -->
      <!-- <li class="post-item"><a href="/set-nginx-cache/">Nginx下关于缓存控制字段cache-control的配置</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/set-nginx-cache/" title="Nginx下关于缓存控制字段cache-control的配置" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723112004.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81/">代码</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/set-nginx-cache/" title="Nginx下关于缓存控制字段cache-control的配置"
                        style="width: 100%; color: #18a0db; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        Nginx下关于缓存控制字段cache-control的配置
                      </a>
                      
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2021-04-27
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
      <!-- <span class="post-date">2021-02-19</span> -->
      <!-- <li class="post-item"><a href="/diskpart/">将磁盘转换为MBR格式</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/diskpart/" title="将磁盘转换为MBR格式" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723092430.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/diskpart/" title="将磁盘转换为MBR格式"
                        style="width: 100%; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        将磁盘转换为MBR格式
                      </a>
                    
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2021-02-19
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
      <!-- <span class="post-date">2021-01-10</span> -->
      <!-- <li class="post-item"><a href="/Hexo-tag-404/">Hexo标签或分类出现404</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/Hexo-tag-404/" title="Hexo标签或分类出现404" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723095124.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81/">代码</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/Hexo-tag-404/" title="Hexo标签或分类出现404"
                        style="width: 100%; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        Hexo标签或分类出现404
                      </a>
                    
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2021-01-10
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
      <!-- <span class="post-date">2020-12-19</span> -->
      <!-- <li class="post-item"><a href="/slideshow/">轮播图实现</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/slideshow/" title="轮播图实现" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723101631.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81/">代码</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/slideshow/" title="轮播图实现"
                        style="width: 100%; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        轮播图实现
                      </a>
                    
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2020-12-19
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
  </ul>
</div>
        

        <!-- <hr style="border: 0;border-top: 1px solid #eaecef;"> -->

        <!-- 分类 -->
        
          
        <!-- <hr style="border: 0;border-top: 1px solid #eaecef;"> -->
          
        <!-- 归档 -->
        
            
        <!-- 标签 -->
        

        <!-- 文章目录 -->
        
          <div class="bar-item post-title-menu-flag">
  <div class="t-h" style="margin-bottom: 10px;">
    <h3 style="color: #094067;">目录</h3>
  </div>
  <div class="post-title-content">
    <ul class="post-title-menu">
    </ul>
  </div>
</div>
        
        <!-- E 侧栏插件 -->
        </div>
        
        <!--  -->
        <div class="post-wrap">
  <article class="post">
    <div class="entry-cate">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/categories/%E4%BB%A3%E7%A0%81/" rel="tag">代码</a></li></ul>
    </div>
    <h1 class="post-article">Nginx下关于缓存控制字段cache-control的配置</h1>
    <div class="entry">
      <!-- S 文章信息 -->
      <div class="p-info-title">
        <div class="u-img">
          <img src="/asset/u.jpg" alt="头像">
        </div>
        <div class="u-title">
          <div class="uname"><span>ler</span></div>
          <div class="post-date"><span>2021-04-27</span>&nbsp;&nbsp;
            
            <a id="reslink" href="https://www.cnblogs.com/kevingrace/p/10459429.html" target="_blank" title="本文转编自：散尽浮华">
              <span class="res">源</span><span class="res-link">散尽浮华</span>
            </a>
            
          </div>
        </div>
      </div>
      <!-- E 文章信息 -->
      <div class="entry-content">
        <p>HTTP协议的<code>Cache-Control</code>指定请求和响应遵循的缓存机制。在请求消息或响应消息中设置<code>Cache-Control</code>并不会影响另一个消息处理过程中的缓存处理过程。</p>
<p><strong>请求时的缓存指令</strong>包括：</p>
<ul>
<li><code>no-cache</code></li>
<li><code>no-store</code></li>
<li><code>max-age</code></li>
<li><code>max-stale</code></li>
<li><code>min-fresh</code></li>
<li><code>only-if-cached</code></li>
</ul>
<p><strong>响应消息中的指令</strong>包括：</p>
<ul>
<li><code>public</code></li>
<li><code>private</code></li>
<li><code>no-cache</code></li>
<li><code>no-store</code></li>
<li><code>no-transform</code></li>
<li><code>must-revalidate</code></li>
<li><code>proxy-revalidate</code></li>
<li><code>max-age</code></li>
</ul>
<p>下面做一详细总结, 方便在以后的运维工作中理解和运用。</p>
<h2 id="一、浏览器中关于Cache的3个属性"><a class="header-anchor" href="#一、浏览器中关于Cache的3个属性"></a>一、浏览器中关于Cache的3个属性</h2>
<h3 id="1-1-Cache-Control"><a class="header-anchor" href="#1-1-Cache-Control"></a>1.1 Cache-Control</h3>
<p>设置相对过期时间, max-age指明以秒为单位的缓存时间. 若对静态资源只缓存一次, 可以设置max-age的值为315360000000 (一万年). 比如对于提交的订单，为了防止浏览器回退重新提交，可以使用Cache-Control之no-store绝对禁止缓存，即便浏览器回退依然请求的是服务器，进而判断订单的状态给出相应的提示信息！</p>
<h4 id="1-1-1-Http协议的cache-control的常见取值及其组合释义："><a class="header-anchor" href="#1-1-1-Http协议的cache-control的常见取值及其组合释义："></a>1.1.1 Http协议的<code>cache-control</code>的常见取值及其组合释义：</h4>
<ul>
<li>
<p><code>no-cache</code>：数据内容不能被缓存, 每次请求都重新访问服务器, 若有max-age, 则缓存期间不访问服务器。</p>
</li>
<li>
<p><code>no-store</code>：不仅不能缓存, 连暂存也不可以（即: 临时文件夹中不能暂存该资源）。</p>
</li>
<li>
<p><code>private</code>(默认)：只能在浏览器中缓存, 只有在第一次请求的时候才访问服务器, 若有max-age, 则缓存期间不访问服务器。</p>
</li>
<li>
<p><code>public</code>：可以被任何缓存区缓存, 如: 浏览器、服务器、代理服务器等。</p>
</li>
<li>
<p><code>max-age</code>：相对过期时间, 即以秒为单位的缓存时间。</p>
</li>
<li>
<p><code>no-cache</code>, <code>private</code>：打开新窗口时候重新访问服务器, 若设置<code>max-age</code>, 则缓存期间不访问服务器。</p>
<ul>
<li>
<p><code>private</code>, <code>max-age</code>为正数：后退时候不会访问服务器。</p>
</li>
<li>
<p><code>no-cache</code>, <code>max-age</code>为正数：后退时会访问服务器。</p>
</li>
</ul>
</li>
</ul>
<h3 id="1-2-Expires"><a class="header-anchor" href="#1-2-Expires"></a>1.2 <code>Expires</code></h3>
<p>设置以分钟为单位的绝对过期时间, 优先级比<code>Cache-Control</code>低, 同时设置<code>Expires</code>和<code>Cache-Control</code>则后者生效。<strong>也就是说要注意一点: <code>Cache-Control</code>的优先级高于<code>Expires</code></strong>。</p>
<p><code>expires</code>起到控制页面缓存的作用，合理配置<code>expires</code>可以减少很多服务器的请求, <code>expires</code>的配置可以在<code>http</code>段中或者<code>server</code>段中或者<code>location</code>段中. 比如控制图片等过期时间为30天, 可以配置如下：</p>
<pre><code class="language-language-bash">location ~ \.(gif|jpg|jpeg|png|bmp|ico)$ {
           root /var/www/img/;
           expires 30d;
       }
</code></pre>
<p>再比如：</p>
<pre><code class="language-language-bash">location ~ \.(wma|wmv|asf|mp3|mmf|zip|rar|swf|flv)$ {
              root /var/www/upload/;
              expires max;
      }
</code></pre>
<h3 id="1-3-Last-Modified"><a class="header-anchor" href="#1-3-Last-Modified"></a>1.3 <code>Last-Modified</code></h3>
<p>该资源的最后修改时间，在浏览器下一次请求资源时，浏览器将先发送一个请求到服务器上，并附上<code>If-Unmodified-Since</code>头来说明浏览器所缓存资源的最后修改时间，如果服务器发现没有修改，则直接返回<code>304</code>（Not Modified）回应信息给浏览器（内容很少），如果服务器对比时间发现修改了，则照常返回所请求的资源。</p>
<h4 id="1-3-1-需要注意"><a class="header-anchor" href="#1-3-1-需要注意"></a>1.3.1 需要注意</h4>
<ul>
<li>
<p><code>Last-Modified</code>属性通常和<code>Expires</code>或<code>Cache-Control</code>属性配合使用，因为即使浏览器设置缓存，当用户点击”刷新”按钮时，浏览器会忽略缓存继续向服务器发送请求，这时<code>Last-Modified</code>将能够很好的减小回应开销。</p>
</li>
<li>
<p><code>ETag</code>将返回给浏览器一个资源ID，如果有了新版本则正常发送并附上新ID，否则返回304， 但是在服务器集群情况下，每个服务器将返回不同的ID，因此不建议使用<code>ETag</code>。</p>
</li>
</ul>
<p>以上描述的客户端浏览器缓存是指存储位置在客户端浏览器，但是对客户端浏览器缓存的实际设置工作是在服务器上的资源中完成的。虽然上面介绍了有关于客户端浏览器缓存的属性，但是实际上对这些属性的设置工作都需要在服务器的资源中做设置。</p>
<p>通常有两种操作手段对浏览器缓存进行设置，一个是通过页面指令声明来设置，另外一个是通过编程方式来设置。</p>
<p>下面是相关页面设置<code>Cache-Control</code>头信息的几个简单配置：</p>
<p>例一：</p>
<pre><code class="language-language-bash">if ($request_uri ~* &quot;^/$|^/search/.+/|^/company/.+/&quot;) {
   add_header    Cache-Control  max-age=3600;
  }
</code></pre>
<p>个人理解的max-age意思是：客户端本地的缓存，在配置的生存时间内的，客户端可以直接使用，超出生存时间的，到服务器上取新数据。当然这些还要看客户端浏览器的设置。</p>
<p>例二：</p>
<pre><code class="language-language-bash">location ~ .*\.(css|js|swf|php|htm|html )$ {
      add_header Cache-Control no-store;
}
</code></pre>
<p>例三：</p>
<pre><code class="language-language-bash">location ~ .*\.(js|css)$ {
     expires 10d;
}
</code></pre>
<p>例四：</p>
<pre><code class="language-language-bash">location / {
    access_log /data/nginx/log/xxx.log api;
    root /home/www/html;
    if ($request_filename ~ .*\.(htm|html)$)
     {
            add_header Cache-Control no-cache;
     }
}
</code></pre>
<p>将html结尾的请求加上no-cache。</p>
<h2 id="二、http-Headers模块-设置HTTP报文的头标"><a class="header-anchor" href="#二、http-Headers模块-设置HTTP报文的头标"></a>二、http Headers模块 (设置HTTP报文的头标)</h2>
<p>Nginx的<code>ngx_http_headers_module</code>模块可以对<code>Cache-Control</code>头相关的东西进行配置，比如：</p>
<pre><code class="language-language-bash">expires     24h;
expires     0;
expires     -1;
expires     epoch;
add_header  Cache-Control  private;
</code></pre>
<ul>
<li>
<p><strong>指令</strong><br>
<code>add_header add_header</code><br>
<code>expires expires</code></p>
</li>
<li>
<p><strong>增加头标</strong><br>
语法： <code>add_header name value</code><br>
默认值： <code>none</code><br>
作用域： <code>http</code>, <code>server</code>, <code>location</code><br>
当HTTP应答状态码为 <code>200</code>、<code>204</code>、<code>301</code>、<code>302</code>或<code>304</code>的时候，增加指定的HTTP头标。其中头标的值可以使用变量。</p>
</li>
<li>
<p><strong>expires</strong><br>
语法： <code>expires [time|epoch|max|off]</code><br>
默认值： <code>expires off</code><br>
作用域： <code>http</code>, <code>server</code>, <code>location</code><br>
使用本指令可以控制HTTP应答中的<code>Expires</code>和<code>Cache-Control</code>的头标（起到控制页面缓存的作用）。</p>
</li>
</ul>
<p>可以在<code>time</code>值中使用正数或负数。<code>Expires</code>头标的值将通过当前系统时间加上您设定的<code>time</code>值来获得。</p>
<pre><code class="language-language-bash">epoch
</code></pre>
<p>指定<code>Expires</code>的值为<code>1 January, 1970, 00:00:01 GMT</code>。</p>
<pre><code class="language-language-bash">max
</code></pre>
<p>指定<code>Expires</code>的值为<code>31 December 2037 23:59:59 GMT</code>，<code>Cache-Control</code>的值为10年。</p>
<p>指定<code>Expires</code>的值为 服务器当前时间 -1s，即永远过期。</p>
<p><code>Cache-Control</code>头标的值由您指定的时间来决定：</p>
<ul>
<li>负数</li>
</ul>
<pre><code class="language-language-bash">Cache-Control: no-cache
</code></pre>
<ul>
<li>正数或零</li>
</ul>
<pre><code class="language-language-bash">Cache-Control: max-age = ``#
</code></pre>
<p><code>#</code>为您指定时间的秒数。</p>
<p><code>off</code>表示不修改<code>Expires</code>和<code>Cache-Control</code>的值；</p>
<h2 id="三、Cache-Control"><a class="header-anchor" href="#三、Cache-Control"></a>三、Cache-Control</h2>
<p><code>Cache-Control</code>通用消息头字段被用于在http请求和响应中通过指定指令来实现缓存机制。缓存指令是单向的, 这意味着在请求设置的指令，在响应中不一定包含相同的指令。</p>
<p>响应头：<code>Cache-Control：no-cache</code>，强制每次请求直接发送给源服务器，而不经过本地缓存版本的校验。这对于需要确认认证应用很有用（可以和<code>public</code>结合使用），或者严格要求使用最新数据的应用（不惜牺牲使用缓存的所有好处）。通俗解释：浏览器通知服务器，本地没有缓存数据。</p>
<p><code>cache-control</code>：</p>
<ul>
<li>
<p><code>max-age</code>大于0时 直接从游览器缓存中提取；</p>
</li>
<li>
<p><code>max-age</code>小于等于0时向server发送http请求确认，该资源是否有修改，有的话返回<code>200</code>，无的话返回<code>304</code>。</p>
</li>
</ul>
<p>通俗解释：响应头中的<code>Cache-Control:max-age=315360000</code>是通知浏览器在<code>315360000</code>秒之内不要烦我，就自己从缓冲区中刷新。</p>
<h3 id="3-1-语法"><a class="header-anchor" href="#3-1-语法"></a>3.1 语法</h3>
<p>指令不区分大小写，并且具有可选参数，可以用令牌或者带引号的字符串语法。多个指令以逗号分隔。</p>
<h3 id="3-2-指令"><a class="header-anchor" href="#3-2-指令"></a>3.2 指令</h3>
<ul>
<li>
<p><strong>可缓存性</strong></p>
<ul>
<li><code>public</code><br>
表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存。表示相应会被缓存，并且在多用户间共享。默认是public。</li>
<li><code>private</code><br>
表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）,可以缓存响应内容。响应只作为私有的缓存，不能在用户间共享。如果要求HTTP认证，响应会自动设置为private。</li>
<li><code>no-cache</code><br>
在释放缓存副本之前，强制高速缓存将请求提交给原始服务器进行验证。指定不缓存响应，表明资源不进行缓存。但是设置了no-cache之后并不代表浏览器不缓存，而是在缓存前要向服务器确认资源是否被更改。因此有的时候只设置no-cache防止缓存还是不够保险，还可以加上private指令，将过期时间设为过去的时间。</li>
<li><code>only-if-cached</code><br>
表明客户端只接受已缓存的响应，并且不要向原始服务器检查是否有更新的拷贝.</li>
</ul>
</li>
<li>
<p><strong>到期</strong></p>
<ul>
<li>
<p><code>max-age=&lt;seconds&gt;</code><br>
设置缓存存储的最大周期，超过这个时间缓存被认为过期(单位秒)。与Expires相反，时间是相对于请求的时间。max-age会覆盖掉Expires。</p>
</li>
<li>
<p><code>s-maxage=&lt;seconds&gt;</code><br>
覆盖max-age 或者 Expires 头，但是仅适用于共享缓存(比如各个代理)，并且私有缓存中它被忽略。也就是说s-maxage只用于共享缓存，比如CDN缓存（s -&gt; share）。与max-age 的区别是：     max-age用于普通缓存，而s-maxage用于代理缓存。如果存在s-maxage,则会覆盖max-age 和 Expires.</p>
</li>
<li>
<p><code>max-stale[=&lt;seconds&gt;]</code><br>
表明客户端愿意接收一个已经过期的资源。 可选的设置一个时间(单位秒)，表示响应不能超过的过时时间。</p>
</li>
<li>
<p><code>min-fresh=&lt;seconds&gt;</code><br>
表示客户端希望在指定的时间内获取最新的响应。</p>
</li>
<li>
<p><code>stale-while-revalidate=&lt;seconds&gt;</code><br>
表明客户端愿意接受陈旧的响应，同时在后台异步检查新的响应。秒值指示客户愿意接受陈旧响应的时间长度。</p>
</li>
<li>
<p><code>stale-if-error=&lt;seconds&gt;</code><br>
表示如果新的检查失败，则客户愿意接受陈旧的响应。秒数值表示客户在初始到期后愿意接受陈旧响应的时间。</p>
</li>
</ul>
</li>
<li>
<p><strong>重新验证和重新加载</strong></p>
<ul>
<li><code>must-revalidate</code><br>
缓存必须在使用之前验证旧资源的状态，并且不可使用过期资源。表示如果页面过期，则去服务器进行获取。</li>
<li><code>proxy-revalidate</code><br>
与must-revalidate作用相同，但它仅适用于共享缓存（例如代理），并被私有缓存忽略。</li>
<li><code>immutable</code><br>
表示响应正文不会随时间而改变。资源（如果未过期）在服务器上不发生改变，因此客户端不应发送重新验证请求头（例如If-None-Match或If-Modified-Since）来检查更新，即使用户显式地刷新页面。在Firefox中，immutable只能被用在 https:// transactions.</li>
</ul>
</li>
<li>
<p><strong>其他</strong></p>
<ul>
<li><code>no-store</code><br>
缓存不应存储有关客户端请求或服务器响应的任何内容。表示绝对禁止缓存!</li>
<li><code>no-transform</code><br>
不得对资源进行转换或转变。Content-Encoding, Content-Range, Content-Type等HTTP头不能由代理修改。例如，非透明代理可以对图像格式进行转换，以便节省缓存空间或者减少缓慢链路上的流量。 no-transform指令不允许这样做。</li>
</ul>
</li>
</ul>
<h3 id="3-3-两个小示例"><a class="header-anchor" href="#3-3-两个小示例"></a>3.3 两个小示例</h3>
<ul>
<li><strong>禁止缓存</strong><br>
发送如下指令可以关闭缓存。此外，可以参考<code>Expires</code>和<code>Pragma</code>标题。</li>
</ul>
<pre><code class="language-language-bash">Cache-Control: no-cache, no-store, must-revalidate
</code></pre>
<ul>
<li><strong>缓存静态资源节</strong><br>
对于应用程序中不会改变的文件，通常可以在发送响应头前添加积极缓存。这包括例如由应用程序提供的静态文件，例如图像，CSS文件和JavaScript文件。另请参阅<code>Expires</code>标题。</li>
</ul>
<pre><code class="language-language-bash">Cache-Control:public, max-age=31536000
</code></pre>
<h3 id="3-4-拓展"><a class="header-anchor" href="#3-4-拓展"></a>3.4 拓展</h3>
<h4 id="3-4-1-HTTP1-0"><a class="header-anchor" href="#3-4-1-HTTP1-0"></a>3.4.1 HTTP1.0</h4>
<p>HTTP1.0中通过<code>Pragma</code>控制页面缓存，通常设置的值为<code>no-cache</code>，不过这个值不这么保险，通常还加上<code>Expires</code>置为<code>0</code>来达到目的。但是如我们刻意需要浏览器或缓存服务器缓存住我们的页面这个值则要设置为<code>Pragma</code>。</p>
<h4 id="3-4-2-HTTP1-1"><a class="header-anchor" href="#3-4-2-HTTP1-1"></a>3.4.2 HTTP1.1</h4>
<p>HTTP1.1中启用<code>Cache-Control</code>来控制页面的缓存与否，<code>Cache-Control</code>是HTTP1.1中的标准，可以看成是<code>expires</code>的补充，使用的是相对时间的概念。</p>
<p><strong>注意几个常用的参数：</strong></p>
<ul>
<li><code>no-cache</code>：浏览器和缓存服务器都不应该缓存页面信息；</li>
<li><code>public:</code> 浏览器和缓存服务器都可以缓存页面信息；</li>
<li><code>no-store</code>：请求和响应的信息都不应该被存储在对方的磁盘系统中；</li>
<li><code>must-revalidate</code>：对于客户机的每次请求，代理服务器必须想服务器验证缓存是否过时</li>
</ul>
<p>目前<code>Cache-Control</code>请求字段被各个浏览器支持的较好，其优先级也比较高，当和别的字段（如<code>Expires</code>）一起用时，会覆盖其他字段。</p>
<h2 id="四、Nginx配置管理浏览器静态缓存策略"><a class="header-anchor" href="#四、Nginx配置管理浏览器静态缓存策略"></a>四、Nginx配置管理浏览器静态缓存策略</h2>
<h3 id="4-1-缓存状态的详细说明"><a class="header-anchor" href="#4-1-缓存状态的详细说明"></a>4.1 缓存状态的详细说明</h3>
<p>浏览器缓存：<code>expires</code>、<code>cache-control</code>、<code>last-modified</code>、<code>etag</code>，先来看一张图:</p>
<p><img src="https://gitee.com/lernb/pic-host/raw/master/img/907596-20190302011346217-1805589363.png" alt=""></p>
<h4 id="4-1-1-Last-Modified"><a class="header-anchor" href="#4-1-1-Last-Modified"></a>4.1.1 <code>Last-Modified</code></h4>
<p>在浏览器第一次请求某一个URL时，服务器端的返回状态会是<code>200</code>，内容是你请求的资源，同时有一个<code>Last-Modified</code>的属性标记（<code>HttpReponse Header</code>）此文件在服务期端最后被修改的时间，格式类似这样：</p>
<pre><code class="language-language-bash">Last-Modified:Tue, 24 Feb 2019 08:01:04 GMT
</code></pre>
<p>客户端第二次请求此URL时，根据HTTP协议的规定，浏览器会向服务器传送<code>If-Modified-Since</code>报头（<code>HttpRequest Header</code>），询问该时间之后文件是否有被修改过：</p>
<pre><code class="language-language-bash">If-Modified-Since:Tue, 24 Feb 2019 08:01:04 GMT
</code></pre>
<p>如果服务器端的资源没有变化，则自动返回<code>304</code>（NotChanged.）状态码内容为空，这样就节省了传输数据量。当服务器端代码发生改变或者重启服务器时，则重新发出资源，返回和第一次请求时类似。从而保证不向客户端重复发出资源，也保证当服务器有变化时，客户端能够得到最新的资源。</p>
<div class="warning">
<p>注意： 如果<code>If-Modified-Since</code>的时间比服务器当前时间（当前的请求时间<code>request_time</code>）还晚，会认为是个非法请求。</p>
</div>
<h4 id="4-1-2-Etag工作原理"><a class="header-anchor" href="#4-1-2-Etag工作原理"></a>4.1.2 <code>Etag</code>工作原理</h4>
<p>HTTP协议规格说明定义<code>ETag</code>为“被请求变量的实体标记”（参见14.19）。简单点即服务器响应时给请求URL标记，并在HTTP响应头中将其传送到客户端，类似服务器端返回的格式：</p>
<pre><code class="language-language-bash">Etag:“5d8c72a5edda8d6a:3239″
</code></pre>
<p>客户端的查询更新格式是这样的：</p>
<pre><code class="language-language-bash">If-None-Match:“5d8c72a5edda8d6a:3239″
</code></pre>
<p>如果<code>ETag</code>没改变，则返回状态<code>304</code>。即：在客户端发出请求后，<code>HttpReponse Header</code>中包含<code>Etag:&quot;5d8c72a5edda8d6a:3239&quot;</code>标识，等于告诉Client端，你拿到的这个的资源有表示ID：<code>5d8c72a5edda8d6a:3239</code>。当下次需要发Request索要同一个URI的时候，浏览器同时发出一个<code>If-None-Match</code>报头（<code>Http RequestHeader</code>）此时包头中信息包含上次访问得到的<code>Etag:&quot;5d8c72a5edda8d6a:3239&quot;</code>标识。</p>
<pre><code class="language-language-bash">If-None-Match:“5d8c72a5edda8d6a:3239“
</code></pre>
<p>这样，Client端等于Cache了两份，服务器端就会比对2者的<code>Etag</code>。如果<code>If-None-Match</code>为<code>False</code>，不返回<code>200</code>，返回<code>304</code>（Not Modified）Response。</p>
<h4 id="4-1-3-Expires"><a class="header-anchor" href="#4-1-3-Expires"></a>4.1.3 Expires</h4>
<p>给出的日期/时间后，被响应认为是过时。如<code>Expires:Thu, 02 Apr 2009 05:14:08 GMT</code>需和<code>Last-Modified</code>结合使用。用于控制请求文件的有效时间，当请求数据在有效期内时客户端浏览器从缓存请求数据而不是服务器端。当缓存中数据失效或过期，才决定从服务器更新数据。</p>
<h4 id="4-1-4-Last-Modified和Expires"><a class="header-anchor" href="#4-1-4-Last-Modified和Expires"></a>4.1.4 <code>Last-Modified</code>和<code>Expires</code></h4>
<p><code>Last-Modified</code>标识能够节省一点带宽，但是还是逃不掉发一个HTTP请求出去，而且要和<code>Expires</code>一起用。而<code>Expires</code>标识却使得浏览器干脆连HTTP请求都不用发，比如当用户F5或者点击Refresh按钮的时候就算对于有<code>Expires</code>的URI，一样也会发一个HTTP请求出去，所以，<code>Last-Modified</code>还是要用的，而且要和<code>Expires</code>一起用。</p>
<h4 id="4-1-5-Etag和Expires"><a class="header-anchor" href="#4-1-5-Etag和Expires"></a>4.1.5 <code>Etag</code>和<code>Expires</code></h4>
<p>如果服务器端同时设置了<code>Etag</code>和<code>Expires</code>时，<code>Etag</code>原理同样，即与<code>Last-Modified/Etag</code>对应的<code>HttpRequestHeader:If-Modified-Since</code>和<code>If-None-Match</code>。我们可以看到这两个<code>Header</code>的值和WebServer发出的<code>Last-Modified</code>，<code>Etag</code>值完全一样；在完全匹配<code>If-Modified-Since</code>和<code>If-None-Match</code>即检查完修改时间和<code>Etag</code>之后，服务器才能返回<code>304</code>。</p>
<h4 id="4-1-6-Last-Modified和Etag"><a class="header-anchor" href="#4-1-6-Last-Modified和Etag"></a>4.1.6 <code>Last-Modified</code>和<code>Etag</code></h4>
<p>分布式系统里多台机器间文件的<code>last-modified</code>必须保持一致，以免负载均衡到不同机器导致比对失败。分布式系统尽量关闭掉<code>Etag</code>（每台机器生成的<code>Etag</code>都会不一样）。</p>
<p><code>Last-Modified</code>和<code>ETags</code>请求的http报头一起使用，服务器首先产生<code>Last-Modified/Etag</code>标记，服务器可在稍后使用它来判断页面是否已经被修改，来决定文件是否继续缓存。</p>
<p><strong>过程如下：</strong></p>
<ol>
<li>客户端请求一个页面（A）。</li>
<li>服务器返回页面A，并在给A加上一个<code>Last-Modified/ETag</code>。</li>
<li>客户端展现该页面，并将页面连同<code>Last-Modified/ETag</code>一起缓存。</li>
<li>客户再次请求页面A，并将上次请求时服务器返回的<code>Last-Modified/ETag</code>一起传递给服务器。</li>
<li>服务器检查该<code>Last-Modified</code>或<code>ETag</code>，并判断出该页面自上次客户端请求之后还未被修改，直接返回响应<code>304</code>和一个空的响应体。</li>
</ol>
<div class="warning">
<p><b>需要注意：</b></p>
<ol>
<li><code>Last-Modified</code>和<code>Etag</code>头都是由WebServer发出的<code>HttpReponse Header</code>，WebServer应该同时支持这两种头；<br></li>
<li>WebServer发送完<code>Last-Modified/Etag</code>头给客户端后，客户端会缓存这些头；<br></li>
<li>客户端再次发起相同页面的请求时，将分别发送与<code>Last-Modified/Etag</code>对应的<code>HttpRequestHeader:If-Modified-Since</code>和<code>If-None-Match</code>。我们可以看到这两个<code>Header</code>的值和WebServer发出的<code>Last-Modified</code>，<code>Etag</code>值完全一样；<br></li>
<li>通过上述值到服务器端检查，判断文件是否继续缓存；</li>
</ol>
</div>
<h4 id="4-1-7-关于Cache-Control-max-age-秒和Expires"><a class="header-anchor" href="#4-1-7-关于Cache-Control-max-age-秒和Expires"></a>4.1.7 关于<code>Cache-Control: max-age=秒</code>和<code>Expires</code></h4>
<p><code>Expires = 时间</code>，HTTP 1.0 版本，缓存的载止时间，允许客户端在这个时间之前不去检查（发请求）；<code>max-age = 秒</code>，HTTP 1.1版本，资源在本地缓存多少秒；如果<code>max-age</code>和<code>Expires</code>同时存在，则被<code>Cache-Control</code>的<code>max-age</code>覆盖。</p>
<p><strong><code>Expires</code>的一个缺点</strong>: 返回的到期时间是服务器端的时间，这样存在一个问题，如果客户端的时间与服务器的时间相差很大，那么误差就很大，所以在HTTP 1.1版开始，使用<code>Cache-Control: max-age=秒</code>替代。</p>
<div class="tip">
<p>Expires=<code>max-age</code> + “每次下载时的当前的request时间”</p>
</div>
<p>所以一旦重新下载的页面后，<code>expires</code>就重新计算一次，但last-modified不会变化.</p>
<h4 id="4-1-8-基于Nginx配置使用总结"><a class="header-anchor" href="#4-1-8-基于Nginx配置使用总结"></a>4.1.8 基于Nginx配置使用总结</h4>
<p>分布式系统（有ng-ha 和 应用的负载均衡），最好使用<code>Last-Modified</code>和<code>Expires</code>，把<code>Etag</code>关闭掉。</p>
<ol>
<li>关闭<code>etag</code></li>
</ol>
<pre><code class="language-language-bash">http {
        etag off;
        }
</code></pre>
<p>关闭<code>etag</code>, 使用<code>Last-Modified</code>和<code>Expires</code></p>
<ol start="2">
<li>配置<code>last-modified</code>（默认开启）和<code>expires</code></li>
</ol>
<pre><code class="language-language-bash">location ~.*\.(gif|jpg|jpeg|png|bmp|swf)$
        {
                expires      30d;
        }
 
location ~.*\.(js|css)?$
        {
                expires      12h;
        }
</code></pre>
<p>对于配置了多个<code>location</code>(upstream)的，可以：</p>
<pre><code class="language-language-bash">location /filebase/ {
            root /hskj/file/;
            autoindex on;
 
            if ($request_filename ~* ^.*?\.(txt|doc|pdf|rar|gz|zip|docx|exe|xlsx|ppt|pptx)$){
                add_header Content-Disposition: 'attachment;';
            }
 
            if ($request_filename ~* ^.*?\.(gif|jpg|jpeg|png|bmp|swf)$){
                expires      30d;
            }
 
            if ($request_filename ~* ^.*?\.(js|css)$){
                expires      12h;
            }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://gitee.com/lernb/pic-host/raw/master/img/907596-20190302015728575-190872568.png" alt=""></p>
<p><strong>配置实例：</strong></p>
<p>Nginx设置不使用缓存<code>add_header Cache-Control no-cache</code></p>
<pre><code class="language-language-bash">server {
    listen       443;
    server_name  www.kevin.com;
    charset utf-8;
 
    ssl                  on;
    ssl_certificate      /daka/program/nginx/conf/server.cer;
    ssl_certificate_key  /daka/program/nginx/conf/server.key;
    ssl_session_timeout  5m;
    ssl_protocols  SSLv2 SSLv3 TLSv1;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers   on;
 
    #设置浏览器缓存
    add_header Cache-Control no-cache;
    add_header Cache-Control private;
  
  
    location /yp {
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://192.168.0.221:8082/yp/yp;
  
        if ($request_filename ~* .*.(html|htm)$)
         {
         expires -1s;
         }
 
         if ($request_filename ~* .*.(gif|jpg|jpeg|png|bmp|swf)$)
         {
         expires 30d;
         }
 
         if ($request_filename ~ .*.(js|css)$)
         {
         expires 12h;
         }
    }
 
       location /static {
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://192.168.0.221:8082/static;
  
        if ($request_filename ~* .*.(html|htm)$)
         {
         expires -1s;
         }
 
         if ($request_filename ~* .*.(gif|jpg|jpeg|png|bmp|swf)$)
         {
         expires 30d;
         }
 
         if ($request_filename ~ .*.(js|css)$)
         {
         expires 12h;
         }
 
    }
  
   location / {
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://192.168.0.221:8080/;
#         if (-e $request_filename){
#           rewrite ^/$ https://www.kevin.com:443/invest/index.jhtml permanent;
#         }
  
  
        if ($request_filename ~* .*.(html|htm)$)
         {
#         expires -1s;
         }
 
         if ($request_filename ~* .*.(gif|jpg|jpeg|png|bmp|swf)$)
         {
         expires 30d;
         }
 
         if ($request_filename ~ .*.(js|css)$)
         {
         expires 12h;
         }
          
    }
}
</code></pre>
<p><strong>运维案例分享：</strong></p>
<ul>
<li>
<p>Nginx增加缓存控制字段<code>cache-control</code></p>
<p>下面是开发部门同事发过来的配置需求:</p>
<ul>
<li>禁用html文件缓存，即<code>cache control</code>设置为<code>no-cache</code>；</li>
<li>对于js，图片，css，字体等，设置<code>max-age=2592000</code>，也就是30天；</li>
</ul>
</li>
</ul>
<div class="tip">
<ul>
<li>
<p>缓存控制字段<code>cache-control</code>的配置（<code>add_header</code>）要放在<code>http</code>，<code>server</code>，<code>location</code>区域，或是放在<code>location</code>的<code>if</code>判断里，例如<code>add_header Cache-Control no-cache;</code>。</p>
</li>
<li>
<p>如果前面有LB负载代理层，则缓存控制字段<code>cache-control</code>配置要放在后端的真实服务器Nginx的<code>location</code>区域，并且要指定root根路径，否则访问会出现<code>404</code> (即找不到访问路径)。</p>
</li>
</ul>
</div>
<p>针对上面的案例需求，操作记录如下：</p>
<p><strong>1) 本案中在实际场景中，有LB层. LB层的Nginx配置不需要配置，这里只是粘贴下负载配置：</strong></p>
<pre><code class="language-language-bash">[root@fvtlb01 ~]# cat /data/nginx/conf/vhosts/fvtkevin-web.kevin.com.conf
upstream fvtkevin-web-inc {
      ip_hash;
      server 172.16.50.73:80  max_fails=3 fail_timeout=15s;
      server 172.16.50.74:80  max_fails=3 fail_timeout=15s;
}
 
  server {
      listen      80;
      server_name fvtkevin-web.kevin.com;
     
      access_log  /data/nginx/logs/fvtkevin-web.kevin.com-access.log main;
      error_log  /data/nginx/logs/fvtkevin-web.kevin.com-error.log;
 
 
 location / {
         proxy_pass http://fvtkevin-web-inc;
         proxy_redirect off ;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header REMOTE-HOST $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_connect_timeout 300;
         proxy_send_timeout 300;
         proxy_read_timeout 600;
         proxy_buffer_size 256k;
         proxy_buffers 4 256k;
         proxy_busy_buffers_size 256k;
         proxy_temp_file_write_size 256k;
         proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504 http_404;
         proxy_max_temp_file_size 128m;
         #proxy_cache mycache;                               
         #proxy_cache_valid 200 302 1h;
         #proxy_cache_valid 301 1d;
         #proxy_cache_valid any 1m;
}
}
</code></pre>
<p><strong>2) 缓存控制字段<code>cache-control</code>的配置要放在后端两台真实服务器<code>172.16.50.73</code>和<code>172.16.50.74</code>上</strong></p>
<p>a) <code>172.16.60.73</code>（即<code>fvtkevin-dmz01.kevin.com</code>）服务器上缓存控制字段<code>cache-control</code>的配置如下:</p>
<pre><code class="language-language-bash">[root@fvtkevin-dmz01 ~]# cat /data/nginx/conf/vhosts/fvtkevin-web01.kevin.com.conf
server {
      listen      80;
      server_name fvtkevin-dmz01.kevin.com;
     
      access_log  /data/nginx/logs/fvtkevin-dmz01.kevin.com-access.log main;
      error_log  /data/nginx/logs/fvtkevin-dmz01.kevin.com-error.log;
 
      location / {
      root /data/web/kevin;
      index index.php index.html index.htm;
      }
 
 
      location ~ \.(css|js|gif|jpg|jpeg|png|bmp|swf|ttf|woff|otf|ttc|pfa)$ {
      root /data/web/kevin;
            expires 30d;
        }
 
      location ~ \.(html|htm)$ {
          root /data/web/kevin;
          add_header Cache-Control no-cache;
        }
 
      location /document/ {
      alias /data/web/document/;
      }
 
      location ~ \.(css|js|gif|jpg|jpeg|png|bmp|swf|ttf|woff|otf|ttc|pfa)$ {
      root /data/web/document;
            expires 30d;
        }
 
      location ~ \.(html|htm)$ {
          root /data/web/document;
          add_header Cache-Control no-cache;
        }
 
  }
</code></pre>
<p>b) <code>172.16.60.74</code>（即<code>fvtkevin-dmz02.kevin.com</code>）服务器上缓存控制字段<code>cache-control</code>的配置如下：</p>
<pre><code class="language-language-bash">[root@fvtkevin-dmz02 ~]# cat /data/nginx/conf/vhosts/fvtkevin-web02.kevin.com.conf
server {
      listen      80;
      server_name fvtkevin-web02.kevin.com;
     
      access_log  /data/nginx/logs/fvtkevin-web02.kevin.com-access.log main;
      error_log  /data/nginx/logs/fvtkevin-web02.kevin.com-error.log;
     
      location / {
      root /data/web/kevin;
      index index.php index.html index.htm;
      }
 
      location ~ \.(css|js|gif|jpg|jpeg|png|bmp|swf|ttf|woff|otf|ttc|pfa)$ {
      root /data/web/kevin;
            expires 30d;
        }
 
      location ~ \.(html|htm)$ {
      root /data/web/kevin;
      add_header Cache-Control no-cache;
        }
 
      location /document/ {
      alias /data/web/document/;
      }
 
 
      location ~ \.(css|js|gif|jpg|jpeg|png|bmp|swf|ttf|woff|otf|ttc|pfa)$ {
      root /data/web/document;
            expires 30d;
        }
 
      location ~ \.(html|htm)$ {
          root /data/web/document;
          add_header Cache-Control no-cache;
        }
 
  }
</code></pre>
<p>以上配置中, 关于缓存控制字段<code>cache-control</code>的配置主要有两个：</p>
<ul>
<li>
<p><code>http://fvtkevin-web.kevin.com/</code>下：<br>
对于html, html格式的文件，<code>cache control</code>设置为<code>no-cache</code>；对于js，图片，css，字体等，设置<code>max-age=2592000</code>；这是基于<code>/data/web/kevin</code>的root根目录下的。</p>
</li>
<li>
<p><code>http://fvtkevin-web.kevin.com/document</code>下：<br>
对于html, html格式的文件，<code>cache control</code>设置为<code>no-cache</code>；对于js，图片，css，字体等，设置<code>max-age=2592000</code>；这是基于<code>/data/web/document</code>的root根目录下的。</p>
</li>
</ul>
<p>以上配置后，访问<code>http://fvtkevin-web.kevin.com/</code>或者<code>http://fvtkevin-web.kevin.com/document</code>进行验证。这里验证一下<code>http://fvtkevin-web.kevin.com/</code>，效果如下：</p>
<p><img src="https://gitee.com/lernb/pic-host/raw/master/img/907596-20190302014938631-3140.png" alt=""></p>
<p>上面显示了<code>http://fvtkevin-web.kevin.com/</code>首页（即index.html文件）访问头部信息里有<code>no-cache</code>信息！</p>
<p><img src="https://gitee.com/lernb/pic-host/raw/master/img/907596-20190302014950193-1878690348.png" alt=""></p>
<p>上面显示了<code>http://fvtkevin-web.kevin.com/*.js</code>文件访问的头部信息里的缓存时间设置！</p>

      </div>
    </div>
    
    <div class="tags clearfix">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li></ul>
    </div>
    
    <script src="/js/prism.js"></script>
  </article>
  <!-- 文章底部导航 -->
  
  <nav id="article-nav" class="clearfix">
    
    
    <a href="/diskpart/" id="article-nav-older" class="article-nav-link-wrap"
      style="text-align: right;">
      <div class="article-nav-title">
        <strong class="article-nav-caption" style="display: block;">下一篇&gt;&gt;</strong>
        <span class="hoverLine hoverLine-thin">将磁盘转换为MBR格式</span>
      </div>
    </a>
    
  </nav>
  
  <!-- 底部文章列表 -->
  <div class="bar-item">
  <div class="t-h hRec" style="margin-bottom: 20px;">
    <h3 style="font-weight: bold; font-size: 18px;">最近</h3>
  </div>
  <ul>
    
      <!-- <span class="post-date">2021-04-27</span> -->
      <!-- <li class="post-item"><a href="/set-nginx-cache/">Nginx下关于缓存控制字段cache-control的配置</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/set-nginx-cache/" title="Nginx下关于缓存控制字段cache-control的配置" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723112004.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81/">代码</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/set-nginx-cache/" title="Nginx下关于缓存控制字段cache-control的配置"
                        style="width: 100%; color: #18a0db; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        Nginx下关于缓存控制字段cache-control的配置
                      </a>
                      
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2021-04-27
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
      <!-- <span class="post-date">2021-02-19</span> -->
      <!-- <li class="post-item"><a href="/diskpart/">将磁盘转换为MBR格式</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/diskpart/" title="将磁盘转换为MBR格式" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723092430.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/diskpart/" title="将磁盘转换为MBR格式"
                        style="width: 100%; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        将磁盘转换为MBR格式
                      </a>
                    
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2021-02-19
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
      <!-- <span class="post-date">2021-01-10</span> -->
      <!-- <li class="post-item"><a href="/Hexo-tag-404/">Hexo标签或分类出现404</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/Hexo-tag-404/" title="Hexo标签或分类出现404" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723095124.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81/">代码</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/Hexo-tag-404/" title="Hexo标签或分类出现404"
                        style="width: 100%; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        Hexo标签或分类出现404
                      </a>
                    
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2021-01-10
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
      <!-- <span class="post-date">2020-12-19</span> -->
      <!-- <li class="post-item"><a href="/slideshow/">轮播图实现</a></li> -->
      <li class="p-list-item clearfix"
        style="border-radius: 10px;">
        <!-- S 文章图片 -->
        
          <div class="post-img" style="display: inline-block; width: 28%; vertical-align: bottom;">
            <a href="/slideshow/" title="轮播图实现" style="float: none; width: 100%; min-height: 70px; border-radius: 10px; overflow: hidden; font-size: 15px;">
              <div class="overlay"></div>
              <img src="https://gitee.com/lernb/pic-host/raw/master/img/20210723101631.jpg" alt="文图" style="min-height: auto; width: 100%; height: 100%;">
            </a>
          </div>
          
            <!-- E 文章图片 -->
            <div class="p-list-item-right" style="position: relative; display: inline-block; width: 67%; margin-left: 2%;">
              <!-- S 标题内容 -->
              <div class="content">
                <div class="ph-cate">
                  <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81/">代码</a></li></ul>
                </div>
                <!-- S 文章标题 -->
                <div class="d-pp-h">
                  <h1 class="" style="line-height: 1.3;">
                    
                      <a class="hoverLine" href="/slideshow/" title="轮播图实现"
                        style="width: 100%; font-size: 14px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all .2s;">
                        轮播图实现
                      </a>
                    
                  </h1>
                </div>
                <!-- E 文章标题 -->

                <!-- S 文章信息 -->
                <div class="post-info" style="padding: 0; margin: 0; border: 0;">
                  <ul>
                    <li class="date post-info-item">
                      <span style="font-size: 12px; font-weight: normal;">
                        2020-12-19
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- E 文章信息 -->
              </div>
              <!-- E 标题内容 -->
            </div>
      </li>
      
  </ul>
</div>
  <!-- 是否开启文章评论 -->
  
  <hr class="comm-hr">
  <h3 class="comm-hd">评论</h3>
  <script src="/js/valines.js"></script>
  <div id="vcomments"></div>
  <script>
    new Valine({
      el: '#vcomments',
      appId: 'vYpfYM8GB7vEYkshouOCPqfU-9Nh9j0Va',
      appKey: 'W2PWpzkDuwbyUlQqyqUFcgYq',
      placeholder: '说点什么吧~',
      requiredFields: ['nick','mail'],
      recordIP: false,
      avatar: 'retro'
    })
  </script>
  <!-- <div class="comment clearfix" style="margin-top: 35px;">
    <div class="split"></div>
    <section id="isso-thread">
    </section>
  </div> -->
  
  <nav id="toTop">TOP</nav>
</div>
<!-- <script src="/js/post20200911.js"></script> -->
<script id="post-js"></script>
<script type="text/javascript">
  let postJs = document.getElementById('post-js');
  if (screen.width < 1236) {
    postJs.setAttribute('src', '/js/post-m20200923.js');
  } else {
    postJs.setAttribute('src', '/js/post20200917.js?v=05191518');
  }
</script>

<!-- <script data-isso="https://lerisso110.lernb.com/isso/" data-isso-require-email="true"
  data-isso-reply-notifications="true" data-isso-vote="false" data-isso-css="false" data-isso-require-author="true"
  src="https://lerisso110.lernb.com/isso/js/embed.min.js"></script> -->

      </div>
    </div>
    </div>
    
      <div class="wrap-content foot-content">
  <!-- S 页面底部 -->
  <div class="foot">
    <div class="foot-con">
      <span id="admin"><a href="https://lernb.com" target="_blank"
          title="LERNB">lernb.com</a>&nbsp;&copy;2021&nbsp;|&nbsp;</span>
      <span id="email"><a href="mailto:lernb@qq.com" title="电子邮件">lernb</a>&nbsp;|</span>
      <!-- <span id="server"><a href="https://cloud.tencent.com/" target="_blank">Tencent</a>&nbsp;|</span> -->
      <span id="siteICP"><a href="http://beian.miit.gov.cn"
          target="_blank">苏ICP备2020049244号</a></span>
    </div>
  </div>
  <!-- E 页面底部 -->
</div>
    
  <script id="layout-js"></script>
  <script type="text/javascript">
    let layoutJs = document.getElementById('layout-js');
    if (screen.width < 1236) {
      layoutJs.setAttribute('src', '/js/layout-m20200920.js?v=0421');
    }
  </script>
</body>

</html>